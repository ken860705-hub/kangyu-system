<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº·ç™’ç¯‰é«” - å€‹æ¡ˆç´€éŒ„ç³»çµ± </title>
    <style>
        /* --- æ ¸å¿ƒè¦–è¦º --- */
        :root {
            --primary: #1e293b;
            --brand: #059669;
            --brand-light: #ecfdf5;
            --accent: #d97706;
            --fpes: #7c3aed;
            --nkt: #0369a1;
            --danger: #dc2626;
            --bg: #f1f5f9;
            --white: #ffffff;
            --border: #cbd5e1;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 10px;
            padding-bottom: 150px;
            font-size: 16px;
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* --- æ¨™é¡Œèˆ‡æ§åˆ¶ --- */
        header {
            background: var(--white);
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border-top: 5px solid var(--brand);
        }
        .header-title h1 { font-size: 1.3rem; margin: 0; font-weight: 800; }
        .action-row { display: flex; gap: 8px; margin-top: 10px; }

        /* --- é¢æ¿ --- */
        .panel {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .section-header {
            font-size: 1.2rem; font-weight: 900; color: var(--primary);
            padding-bottom: 10px; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9;
            display: flex; align-items: center; gap: 8px;
        }
        .section-tag {
            background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 4px;
            font-size: 0.9rem; font-weight: bold;
        }
        
        h3 {
            margin: 0 0 15px 0; font-size: 1.1rem; color: var(--primary);
            display: flex; align-items: center; gap: 8px;
        }
        h3::before { content: ''; width: 5px; height: 20px; background: var(--brand); border-radius: 4px; }

        /* --- æ­·å²ç´€éŒ„ --- */
        #historyPanel { display: none; background: #ecfdf5; border: 1px solid #6ee7b7; }
        .history-card {
            background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 8px;
            border-left: 4px solid var(--brand); box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .history-date { font-size: 0.85rem; color: #64748b; font-weight: bold; margin-bottom: 4px; }
        .history-content { font-size: 0.95rem; color: #334155; line-height: 1.5; white-space: pre-line; }

        /* --- è¼¸å…¥èˆ‡æ¨™ç±¤ --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        input[type="text"], input[type="tel"], input[type="date"], select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 8px; font-size: 1rem; background: #fff; appearance: none; height: 48px;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }
        .date-wrap { position: relative; }
        .date-label { position: absolute; top: -8px; left: 10px; background: #fff; padding: 0 5px; font-size: 0.75rem; color: #64748b; font-weight: bold; }

        .tag-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .tag-btn {
            padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 6px;
            background: #fff; color: #64748b; font-size: 0.9rem; cursor: pointer;
        }
        .tag-btn.active { background: var(--brand); color: #fff; border-color: var(--brand); font-weight: bold;}
        .tag-btn.alert { border-color: #fca5a5; color: #dc2626; }
        .tag-btn.alert.active { background: #dc2626; color: #fff; border-color: var(--danger); }
        
        .goal-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .goal-btn {
            flex: 1; padding: 15px 5px; border: 2px solid #e2e8f0; border-radius: 12px;
            background: #fff; color: #64748b; font-weight: bold; cursor: pointer; text-align: center;
            transition: 0.2s;
        }
        .goal-btn.active { border-color: var(--brand); background: #ecfdf5; color: var(--brand); box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.2); }

        /* --- ä¸»è¨´æŒ‰éˆ• --- */
        .part-section { margin-bottom: 15px; }
        .part-label { font-size: 0.9rem; font-weight: bold; color: var(--accent); margin-bottom: 8px; display: block; border-left: 4px solid var(--accent); padding-left: 8px; }
        .part-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        @media (max-width: 400px) { .part-grid { grid-template-columns: repeat(3, 1fr); } }
        
        .part-btn { padding: 12px 2px; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; text-align: center; font-weight: bold; color: #475569; cursor: pointer; font-size: 0.95rem; }
        .part-btn:active { background: #e2e8f0; transform: scale(0.95); }

        #painResult { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; padding: 10px; background: #f1f5f9; border-radius: 8px; border: 1px dashed #cbd5e1; min-height: 50px; }
        .pain-chip { background: var(--primary); color: #fff; padding: 8px 12px; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; animation: popIn 0.2s; }
        .pain-chip .del { cursor: pointer; opacity: 0.7; font-weight: bold; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- ROM æŒ‰éˆ• --- */
        .rom-category-list { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .rom-cat-btn { flex: 0 0 auto; padding: 10px 16px; border-radius: 20px; background: #f1f5f9; color: #64748b; font-weight: bold; cursor: pointer; border: 1px solid #e2e8f0; }
        .rom-cat-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .rom-action-area { display: none; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .rom-action-area.active { display: block; animation: fadeIn 0.2s; }
        .rom-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .rom-btn { padding: 12px 5px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; text-align: center; font-size: 0.9rem; font-weight: bold; color: #475569; cursor: pointer; }
        .rom-btn:active { background: #e2e8f0; }
        .rom-record { background: #fff7ed; border: 1px solid #fdba74; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .rom-record strong { color: #c2410c; }

        /* --- AI & Search --- */
        #aiSuggestionBox { background: var(--bg); border: 1px solid #d8b4fe; border-radius: 8px; padding: 12px; margin-bottom: 20px; display: none; margin-top: 10px; }
        .ai-title { color: var(--fpes); font-weight: 800; font-size: 0.95rem; margin-bottom: 10px; }
        .ai-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .ai-chip { background: #fff; color: var(--fpes); border: 1px solid #d8b4fe; padding: 8px 14px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
        
        .search-wrap { position: relative; width: 100%; flex: 1; }
        .dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; background: #fff; border: 1px solid #94a3b8; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .dropdown li { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .dropdown li:active { background: #e2e8f0; }

        /* --- æŒ‰éˆ•çµ„ --- */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 5px; }
        .btn:active { transform: scale(0.98); }
        .btn-add { background: #e0f2fe; color: #0284c7; border: 1px dashed #0284c7; }
        .btn-logic { background: #fef3c7; color: #d97706; border: 1px dashed #d97706; }
        .btn-del { width: 32px; height: 32px; padding: 0; background: #fee2e2; color: #ef4444; border-radius: 50%; font-size: 1.2rem; margin-left: auto; }
        
        .btn-save { background: #3b82f6; color: #fff; flex:1; }
        .btn-archive { background: #059669; color: #fff; flex:1; }
        .btn-download { background: #8b5cf6; color: #fff; flex:1; }
        .btn-print { background: #f59e0b; color: #000; }

        /* --- è¨˜éŒ„è¡Œèˆ‡å‚™è¨» --- */
        .record-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .row-controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 5px; }
        .logic-row { background: #fffbeb; border: 1px solid #fcd34d; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .logic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .logic-label { font-size: 0.8rem; font-weight: bold; color: #d97706; }
        
        .manual-note { width: 100%; margin-top: 10px; padding: 10px; border: 1px dashed #94a3b8; background: #f8fafc; border-radius: 8px; min-height: 50px; resize: vertical; }
        .fpes-context { background: #f5f3ff; border: 1px solid #d8b4fe; border-radius: 8px; padding: 15px; margin-bottom: 15px; color: var(--fpes); }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-card { background: #fff; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-label { display: block; font-weight: bold; margin-bottom: 10px; color: #64748b; }
        .nail-input-box { display: none; margin-top: 10px; padding: 12px; border: 2px solid #fca5a5; background: #fff5f5; border-radius: 8px; }
        .nail-input-box.show { display: block; }

        @media print {
            .no-print, .btn, .rom-category-list { display: none !important; }
            .panel { box-shadow: none; border: 1px solid #000; break-inside: avoid; }
            input, select, textarea { border: none; padding: 0; resize: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <header class="no-print">
        <div>
            <h1>åº·ç™’ç¯‰é«”</h1>
            <span style="font-size:0.8rem; color:#666;">v35.0 (Full Features)</span>
        </div>
        <div class="action-row">
            <button class="btn btn-save" onclick="tempSave()">ğŸ’¾ æš«å­˜</button>
            <button class="btn btn-archive" onclick="archiveRecord()">âœ… çµæ¡ˆæ­¸æª”</button>
            <button class="btn btn-download" onclick="downloadText()">ğŸ“¥ ä¸‹è¼‰</button>
        </div>
        <button class="btn btn-print" style="margin-top:8px;" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / PDF</button>
    </header>

    <div class="panel no-print" id="historyPanel">
        <h3 style="color:var(--brand);">ğŸ“œ æ­·å²ç´€éŒ„ (History)</h3>
        <div id="historyList"></div>
    </div>

    <div class="panel">
        <h3>ğŸ“ å®¢æˆ¶åŸºæœ¬è³‡æ–™</h3>
        <div class="form-grid">
            <input type="text" id="pName" placeholder="å§“å Name (è¼¸å…¥å¾Œè‡ªå‹•æœå°‹)" onblur="searchHistory()" oninput="tempSave()">
            <select id="pGender" onchange="tempSave()" style="background:#fff;">
                <option value="">æ€§åˆ¥...</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option><option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <input type="tel" id="pPhone" placeholder="é›»è©±" oninput="tempSave()">
            <div class="date-wrap"><span class="date-label">ç”Ÿæ—¥</span><input type="date" id="pBirthday" oninput="tempSave()"></div>
            <div class="date-wrap"><span class="date-label">è©•ä¼°æ—¥æœŸ</span><input type="date" id="dateToday" oninput="tempSave()"></div>
            <input type="text" id="pTherapist" placeholder="è©•ä¼°è€…" oninput="tempSave()">
        </div>
        <div class="goal-group">
            <div class="goal-btn" onclick="toggleGoal(this)">ğŸ’†â€â™‚ï¸ æ”¾é¬†æŒ‰æ‘©</div>
            <div class="goal-btn" onclick="toggleGoal(this)">ğŸ”§ è§£æ±ºå•é¡Œ</div>
            <div class="goal-btn" onclick="toggleGoal(this)">âœ¨ å…©è€…éƒ½æƒ³è¦</div>
        </div>
    </div>

    <div class="panel">
        <h3>ğŸ”´ ä¸é©éƒ¨ä½èˆ‡æ„Ÿå— (Chief Complaint)</h3>
        
        <div class="part-section">
            <span class="part-label">ä¸­è»¸/è»€å¹¹ (Axial)</span>
            <div class="part-grid">
                <div class="part-btn" onclick="openPainModal('é ­éƒ¨')">é ­éƒ¨</div>
                <div class="part-btn" onclick="openPainModal('é ¸éƒ¨')">é ¸éƒ¨</div>
                <div class="part-btn" onclick="openPainModal('èƒ¸å£')">èƒ¸å£</div> <div class="part-btn" onclick="openPainModal('èƒŒéƒ¨')">èƒŒéƒ¨</div>
                <div class="part-btn" onclick="openPainModal('è…¹éƒ¨')">è…¹éƒ¨</div> <div class="part-btn" onclick="openPainModal('è…°éƒ¨')">è…°éƒ¨</div>
                <div class="part-btn" onclick="openPainModal('éª¨ç›†')">éª¨ç›†</div>
            </div>
        </div>

        <div class="part-section">
            <span class="part-label">å››è‚¢ (Limbs)</span>
            <div class="part-grid">
                <div class="part-btn" onclick="openPainModal('è‚©è†€')">è‚©è†€</div>
                <div class="part-btn" onclick="openPainModal('ä¸Šè‡‚')">ä¸Šè‡‚</div>
                <div class="part-btn" onclick="openPainModal('è‚˜/å‰è‡‚')">è‚˜/å‰è‡‚</div>
                <div class="part-btn" onclick="openPainModal('æ‰‹éƒ¨')">æ‰‹è…•/æ‰‹</div>
                <div class="part-btn" onclick="openPainModal('é«–éƒ¨')">é«–éƒ¨</div>
                <div class="part-btn" onclick="openPainModal('å¤§è…¿')">å¤§è…¿</div>
                <div class="part-btn" onclick="openPainModal('è†è“‹')">è†è“‹</div>
                <div class="part-btn" onclick="openPainModal('å°è…¿')">å°è…¿</div>
                <div class="part-btn" onclick="openPainModal('è…³è¸/è¶³')">è…³è¸/è¶³</div>
            </div>
        </div>

        <div id="painResult"></div>
        <textarea class="manual-note" id="note_pain" placeholder="ğŸ“ æ‰‹å‹•å‚™è¨»..." oninput="tempSave()"></textarea>
        
        <hr style="border:0; border-top:1px dashed #cbd5e1; margin:20px 0;">
        
        <h3>ğŸƒ ç”Ÿæ´»èˆ‡ç—…å²</h3>
        <label>å·¥ä½œ/é‹å‹•/å¥åº· (è«‹æ“ä½œæ¨™ç±¤)</label>
        <div class="tag-group">
            <div class="tag-btn" onclick="toggleBtn(this)">ä¹…å</div>
            <div class="tag-btn" onclick="toggleBtn(this)">ä¹…ç«™</div>
            <div class="tag-btn" onclick="toggleBtn(this)">æ¬é‡ç‰©</div>
            <div class="tag-btn" onclick="toggleBtn(this)">é‹å‹•é¸æ‰‹</div>
            <div class="tag-btn" onclick="toggleBtn(this)">é‡è¨“</div>
            <div class="tag-btn" onclick="toggleBtn(this)">ç¡çœ å›°é›£</div>
            <div class="tag-btn alert" onclick="toggleBtn(this)">æ›¾å‹•éæ‰‹è¡“</div>
            <div class="tag-btn alert" onclick="toggleNail(this)">é«”å…§æœ‰é‹¼é‡˜</div>
        </div>
        <div id="nailInput" class="nail-input-box"><input type="text" id="note_nail" placeholder="é‹¼é‡˜ä½ç½®..." oninput="tempSave()"></div>
        <textarea class="manual-note" id="note_history" placeholder="ğŸ“ å…¶ä»–ç—…å²å‚™è¨»..." oninput="tempSave()"></textarea>
    </div>

    <div class="panel">
        <div class="section-header"><span class="section-tag">Step 1</span> å‹•ä½œå—é™å¿«ç¯© (ROM)</div>
        <div class="rom-category-list">
            <div class="rom-cat-btn active" onclick="showRomCat('neck')">é ­é ¸</div>
            <div class="rom-cat-btn" onclick="showRomCat('tspine')">èƒ¸æ¤</div>
            <div class="rom-cat-btn" onclick="showRomCat('trunk')">è…°æ¤</div>
            <div class="rom-cat-btn" onclick="showRomCat('scap')">è‚©èƒ›éª¨</div>
            <div class="rom-cat-btn" onclick="showRomCat('shld')">è‚©é—œç¯€</div>
            <div class="rom-cat-btn" onclick="showRomCat('hip')">é«–é—œç¯€</div>
            <div class="rom-cat-btn" onclick="showRomCat('knee')">è†/è¸</div>
        </div>
        
        <div id="rom-neck" class="rom-action-area active"><div class="rom-btn-grid"><div class="rom-btn" onclick="addRomRecord('é ­é ¸å‰å½')">å‰å½</div><div class="rom-btn" onclick="addRomRecord('é ­é ¸å¾Œä»°')">å¾Œä»°</div><div class="rom-btn" onclick="addRomRecord('é ­é ¸æ—‹è½‰',true)">æ—‹è½‰</div><div class="rom-btn" onclick="addRomRecord('é ­é ¸å´å½',true)">å´å½</div></div></div>
        <div id="rom-tspine" class="rom-action-area"><div class="rom-btn-grid"><div class="rom-btn" onclick="addRomRecord('èƒ¸æ¤æ—‹è½‰',true)">æ—‹è½‰</div><div class="rom-btn" onclick="addRomRecord('èƒ¸æ¤å¾Œä»°')">å¾Œä»°</div><div class="rom-btn" onclick="addRomRecord('èƒ¸æ¤å‰å½')">å‰å½</div><div class="rom-btn" onclick="addRomRecord('èƒ¸æ¤å´å½',true)">å´å½</div></div></div>
        <div id="rom-trunk" class="rom-action-area"><div class="rom-btn-grid"><div class="rom-btn" onclick="addRomRecord('è…°æ¤å‰å½')">å‰å½</div><div class="rom-btn" onclick="addRomRecord('è…°æ¤å¾Œä»°')">å¾Œä»°</div><div class="rom-btn" onclick="addRomRecord('è…°æ¤æ—‹è½‰',true)">æ—‹è½‰</div><div class="rom-btn" onclick="addRomRecord('è…°æ¤å´å½',true)">å´å½</div></div></div>
        <div id="rom-scap" class="rom-action-area"><div class="rom-btn-grid"><div class="rom-btn" onclick="addRomRecord('è‚©èƒ›ä¸Šæ',true)">ä¸Šæ</div><div class="rom-btn" onclick="addRomRecord('è‚©èƒ›ä¸‹å£“',true)">ä¸‹å£“</div><div class="rom-btn" onclick="addRomRecord('è‚©èƒ›å‰çª',true)">å‰çª</div><div class="rom-btn" onclick="addRomRecord('è‚©èƒ›å¾Œç¸®',true)">å¾Œç¸®</div><div class="rom-btn" onclick="addRomRecord('è‚©èƒ›ä¸Šæ—‹',true)">ä¸Šæ—‹</div><div class="rom-btn" onclick="addRomRecord('è‚©èƒ›ä¸‹æ—‹',true)">ä¸‹æ—‹</div></div></div>
        <div id="rom-shld" class="rom-action-area"><div class="rom-btn-grid"><div class="rom-btn" onclick="addRomRecord('è‚©å‰å±ˆ',true)">å‰å±ˆ</div><div class="rom-btn" onclick="addRomRecord('è‚©å¾Œä¼¸',true)">å¾Œä¼¸</div><div class="rom-btn" onclick="addRomRecord('è‚©å¤–å±•',true)">å¤–å±•</div><div class="rom-btn" onclick="addRomRecord('è‚©å…§æ—‹',true)">å…§æ—‹</div><div class="rom-btn" onclick="addRomRecord('è‚©å¤–æ—‹',true)">å¤–æ—‹</div></div></div>
        <div id="rom-hip" class="rom-action-area"><div class="rom-btn-grid"><div class="rom-btn" onclick="addRomRecord('é«–å±ˆæ›²',true)">å±ˆæ›²</div><div class="rom-btn" onclick="addRomRecord('é«–å¾Œä¼¸',true)">å¾Œä¼¸</div><div class="rom-btn" onclick="addRomRecord('é«–å¤–å±•',true)">å¤–å±•</div><div class="rom-btn" onclick="addRomRecord('é«–å…§æ—‹',true)">å…§æ—‹</div><div class="rom-btn" onclick="addRomRecord('é«–å¤–æ—‹',true)">å¤–æ—‹</div></div></div>
        <div id="rom-knee" class="rom-action-area"><div class="rom-btn-grid"><div class="rom-btn" onclick="addRomRecord('è†ä¼¸ç›´',true)">è†ä¼¸ç›´</div><div class="rom-btn" onclick="addRomRecord('æ·±è¹²å—é™')">æ·±è¹²å—é™</div><div class="rom-btn" onclick="addRomRecord('è¶³èƒŒå±ˆ',true)">è¶³èƒŒå±ˆ</div><div class="rom-btn" onclick="addRomRecord('è¶³è¹ å±ˆ',true)">è¶³è¹ å±ˆ</div></div></div>

        <div id="romResultList"></div>
        <div id="aiSuggestionBox"><div class="ai-title">âœ¨ æ™ºèƒ½å»ºè­° (é»æ“ŠåŠ å…¥)</div><div class="ai-chips" id="aiChipsContainer"></div></div>
        
        <div style="margin-top:20px;">
            <label style="color:var(--brand); font-weight:bold;">ğŸ¯ é‡é»æ”¾é¬†éƒ¨ä½ (Focus)</label>
            <div id="relaxContainer"></div>
            <button class="btn btn-add no-print" onclick="addRelaxRow()">ï¼‹ æ–°å¢æ”¾é¬†è‚Œè‚‰</button>
            <textarea class="manual-note" id="note_relax" placeholder="ğŸ“ ROM å‚™è¨»..." oninput="tempSave()"></textarea>
        </div>
    </div>

    <div class="panel">
        <div class="section-header" style="color:var(--fpes); border-color:var(--fpes);"><span class="section-tag" style="background:var(--fpes);">Step 2</span> FPES ç—›æºç¯©æª¢</div>
        <div class="fpes-context"><div class="fpes-context-title">ğŸ”´ ç›®å‰ä¸»è¨´ (åƒç…§)</div><div id="fpesContextText" style="font-size:0.9rem;">å°šæœªè¨˜éŒ„</div></div>
        <div id="fpesContainer"></div>
        <button class="btn btn-add" style="border-color:var(--fpes); color:var(--fpes);" onclick="addFpesRow()">ï¼‹ æ–°å¢ç¯©æª¢</button>
        <textarea class="manual-note" id="note_fpes" placeholder="ğŸ“ FPES å‚™è¨»..." oninput="tempSave()"></textarea>
    </div>

    <div class="panel">
        <div class="section-header" style="color:var(--nkt); border-color:var(--nkt);"><span class="section-tag" style="background:var(--nkt);">Step 3</span> NKT è©•ä¼°</div>
        <h4 style="margin:10px 0; color:#475569;">1. å¹²æ“¾æ¸¬è©¦</h4>
        <div id="interferenceContainer"></div>
        <button class="btn btn-add" onclick="addInterferenceRow()">ï¼‹ æ–°å¢æ¸¬è©¦</button>
        <h4 style="margin:20px 0 10px 0; color:#475569;">2. åå‘ TL (Logic)</h4>
        <div id="logicContainer"></div>
        <button class="btn btn-logic" onclick="addLogicRow()">ï¼‹ æ–°å¢é‚è¼¯</button>
        <h4 style="margin:20px 0 10px 0; color:#475569;">3. èª¿ç†é…å°</h4>
        <div id="protocolContainer"></div>
        <button class="btn btn-add" onclick="addProtocolRow()">ï¼‹ æ–°å¢é…å°</button>
        <textarea class="manual-note" id="note_nkt" placeholder="ğŸ“ NKT å‚™è¨»..." oninput="tempSave()"></textarea>
    </div>

    <div class="panel">
        <h3>ğŸ“ ç¸½çµèˆ‡å»ºè­°</h3>
        <textarea id="summaryArea" rows="5" placeholder="è¼¸å…¥ç¸½çµ..." oninput="tempSave()"></textarea>
    </div>
</div>

<div class="modal-overlay" id="painModal">
    <div class="modal-card">
        <div class="modal-title">ç´°ç¯€ - <span id="modalPartTitle"></span></div>
        <div class="modal-sec"><div class="modal-label">æ–¹å‘</div><div class="tag-group" id="modalSide"><div class="tag-btn" onclick="selectSingle(this)">å·¦</div><div class="tag-btn" onclick="selectSingle(this)">å³</div><div class="tag-btn" onclick="selectSingle(this)">é›™å´</div><div class="tag-btn" onclick="selectSingle(this)">ä¸­è»¸</div></div></div>
        <div class="modal-sec"><div class="modal-label">ç‹€æ…‹</div><div class="tag-group" id="modalState"><div class="tag-btn" onclick="selectSingleState(this)">å‹• (Move)</div><div class="tag-btn" onclick="selectSingleState(this)">éœ (Static)</div><div class="tag-btn" onclick="selectSingleState(this)">ä¸åˆ†</div></div></div>
        <div class="modal-sec"><div class="modal-label">æ„Ÿå—</div><div class="tag-group" id="modalSense"><div class="tag-btn" onclick="toggleBtn(this)">ç— </div><div class="tag-btn" onclick="toggleBtn(this)">ç—›</div><div class="tag-btn" onclick="toggleBtn(this)">éº»</div><div class="tag-btn" onclick="toggleBtn(this)">ç·Š</div><div class="tag-btn" onclick="toggleBtn(this)">å¡</div><div class="tag-btn" onclick="toggleBtn(this)">ç„¡åŠ›</div></div></div>
        <div style="display:flex;gap:10px;"><button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="closeModal(false)">å–æ¶ˆ</button><button class="btn" style="background:#3b82f6;color:#fff;" onclick="closeModal(true)">ç¢ºèª</button></div>
    </div>
</div>

<div class="modal-overlay" id="romSideModal">
    <div class="modal-card">
        <div class="modal-title">å—é™æ–¹å‘</div>
        <div style="display:flex;gap:10px;margin-bottom:15px;"><button class="btn" style="background:#f1f5f9;color:#475569;" onclick="confirmRomSide('å·¦ (L)')">å·¦ (L)</button><button class="btn" style="background:#f1f5f9;color:#475569;" onclick="confirmRomSide('å³ (R)')">å³ (R)</button><button class="btn" style="background:#f1f5f9;color:#475569;" onclick="confirmRomSide('é›™å´')">é›™å´</button></div>
        <button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="document.getElementById('romSideModal').classList.remove('open')">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // --- 1. DB ---
    const DB = [{n:"èƒ¸é–ä¹³çªè‚Œ (SCM)"},{n:"ä¸Šæ–œæ–¹è‚Œ (UT)"},{n:"é—ŠèƒŒè‚Œ (LD)"},{n:"è…°å¤§è‚Œ (PM)"},{n:"è‡€å¤§è‚Œ (GMax)"},{n:"è‚¡ç›´è‚Œ (RF)"},{n:"èƒ¸å°è‚Œ (PMi)"},{n:"å‰é‹¸è‚Œ (SA)"},{n:"è…¹å…§æ–œè‚Œ (IO)"},{n:"è…¹å¤–æ–œè‚Œ (EO)"},{n:"è±è„Šè‚Œ (ES)"},{n:"è…°æ–¹è‚Œ (QL)"}]; 
    const SUGGESTIONS = {"æ—‹è½‰":["è…¹å¤–æ–œè‚Œ","è…¹å…§æ–œè‚Œ","é—ŠèƒŒè‚Œ"], "å´å½":["è…°æ–¹è‚Œ","è±è„Šè‚Œ"], "å‰å½":["è±è„Šè‚Œ","è…¿å¾Œè‚Œ"], "å¾Œä»°":["è…¹ç›´è‚Œ","è…°å¤§è‚Œ"], "å‰å±ˆ":["é—ŠèƒŒè‚Œ","èƒ¸å¤§è‚Œ"], "å¤–å±•":["èƒ¸å¤§è‚Œ","å¤§åœ“è‚Œ"], "å…§æ—‹":["æ£˜ä¸‹è‚Œ","å°åœ“è‚Œ"], "å¤–æ—‹":["è‚©èƒ›ä¸‹è‚Œ","èƒ¸å¤§è‚Œ"], "ä¸Šæ":["ä¸‹æ–œæ–¹è‚Œ"], "ä¸‹å£“":["ä¸Šæ–œæ–¹è‚Œ"]};
    const JOINTS = ["C1-C7", "T1-T12", "L1-L5", "Sacrum", "SI Joint", "Hip", "Knee", "Ankle", "Shoulder", "Elbow", "Wrist"];

    // --- 2. åˆå§‹åŒ– ---
    window.onload = function() {
        document.getElementById('dateToday').valueAsDate = new Date();
        if(document.getElementById('relaxContainer').children.length === 0) addRelaxRow();
        if(document.getElementById('interferenceBody').children.length === 0) addInterferenceRow();
        if(document.getElementById('logicContainer').children.length === 0) addLogicRow();
        if(document.getElementById('treatmentBody').children.length === 0) addProtocolRow();
        if(document.getElementById('fpesContainer').children.length === 0) addFpesRow();
        const d = JSON.parse(localStorage.getItem('nkt_v35_temp'));
        if(d && d.name) document.getElementById('pName').value = d.name;
    };

    // --- 3. UI äº’å‹• (Pain Modal, Toggles) ---
    window.toggleGoal = function(el) { el.parentElement.querySelectorAll('.goal-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); };
    window.toggleBtn = function(el) { el.classList.toggle('active'); };
    window.toggleNail = function(el) { el.classList.toggle('active'); document.getElementById('nailInput').style.display = el.classList.contains('active')?'block':'none'; };
    
    let currentPart = "";
    window.openPainModal = function(part) {
        currentPart = part;
        document.getElementById('modalPartTitle').innerText = part;
        document.querySelectorAll('#modalSide .tag-btn, #modalState .tag-btn, #modalSense .tag-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('painModal').classList.add('open');
    };
    window.selectSingle = function(el) { el.parentElement.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); };
    window.selectSingleState = function(el) { el.parentElement.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); };
    
    window.closeModal = function(save) {
        if(save) {
            const side = document.querySelector('#modalSide .tag-btn.active')?.innerText || "";
            const state = document.querySelector('#modalState .tag-btn.active')?.innerText || "";
            const senses = [];
            document.querySelectorAll('#modalSense .tag-btn.active').forEach(b => senses.push(b.innerText));
            const div = document.createElement('div');
            div.className = 'pain-chip';
            div.innerHTML = `<strong>${currentPart}</strong> ${side?`(${side})`:''} ${state?`[${state}]`:''} ${senses.join(',')} <span class="del" onclick="this.parentElement.remove(); updateFPESContext()">Ã—</span>`;
            document.getElementById('painResult').appendChild(div);
            updateFPESContext();
        }
        document.getElementById('painModal').classList.remove('open');
    };

    // --- 4. ROM é‚è¼¯ ---
    window.showRomCat = function(id) {
        document.querySelectorAll('.rom-action-area').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.rom-cat-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('rom-'+id).classList.add('active');
        event.target.classList.add('active');
    };
    let currentRomAction = "";
    window.addRomRecord = function(a,s){ if(s){ currentRomAction=a; document.getElementById('romSideModal').classList.add('open'); } else { createRomRecord(a,""); }};
    window.confirmRomSide = function(s){ createRomRecord(currentRomAction, s); document.getElementById('romSideModal').classList.remove('open'); };
    function createRomRecord(a,s){
        const d = document.createElement('div'); d.className='rom-record';
        // AI Logic
        let keyword = ""; for(let k in SUGGESTIONS) if(a.includes(k)) keyword = k;
        if(keyword && SUGGESTIONS[keyword]) {
            const container = document.getElementById('aiChipsContainer');
            document.getElementById('aiSuggestionBox').style.display = 'block';
            SUGGESTIONS[keyword].forEach(m => {
                if(!container.innerHTML.includes(m)) {
                    let chip = document.createElement('div'); chip.className='ai-chip'; chip.innerHTML=`<span>+</span> ${m}`;
                    chip.onclick = function(){ addRelaxRowWithValue(m); this.style.background='#dcfce7'; };
                    container.appendChild(chip);
                }
            });
        }
        d.innerHTML = `<div><strong>${a}</strong> ${s}</div><span style="color:#d97706;font-weight:bold;cursor:pointer;" onclick="this.parentElement.remove()">Ã—</span>`;
        document.getElementById('romResultList').appendChild(d);
    }

    // --- 5. æœå°‹èˆ‡è³‡æ–™åº« ---
    window.doSearch = function(input, type) {
        const val = input.value.toLowerCase().trim();
        const list = input.nextElementSibling;
        list.innerHTML = ''; list.style.display = 'none';
        if(type==='muscle') {
            if(!val) return;
            const matches = DB.filter(d => d.n.toLowerCase().includes(val));
            if(matches.length>0){ list.style.display='block'; matches.forEach(i=>{ let liL=document.createElement('li'); liL.innerHTML=`<span>${i.n} (L)</span>`; liL.onmousedown=function(e){e.preventDefault();input.value=i.n+" (L)";list.style.display='none'}; list.appendChild(liL); let liR=document.createElement('li'); liR.innerHTML=`<span>${i.n} (R)</span>`; liR.onmousedown=function(e){e.preventDefault();input.value=i.n+" (R)";list.style.display='none'}; list.appendChild(liR); }); }
        } else if(type==='joint') {
            list.style.display='block'; JOINTS.forEach(j=>{ let li=document.createElement('li'); li.innerHTML=j; li.onmousedown=function(e){e.preventDefault();input.value=j;list.style.display='none'}; list.appendChild(li); });
        }
    };
    document.addEventListener('click', e => { if(!e.target.closest('.search-wrap')) document.querySelectorAll('.dropdown').forEach(d => d.style.display='none'); });

    // --- 6. æ¬„ä½æ–°å¢ ---
    window.addRelaxRow = function() {
        const d = document.createElement('div'); d.style.marginBottom='10px'; d.style.display='flex'; d.style.gap='5px';
        d.innerHTML = `<div class="search-wrap" style="flex:1"><input type="text" placeholder="æœå°‹è‚Œè‚‰..." onfocus="doSearch(this,'muscle')" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('relaxContainer').appendChild(d);
    };
    function addRelaxRowWithValue(val) { addRelaxRow(); let inputs = document.querySelectorAll('#relaxContainer input'); inputs[inputs.length-1].value = val; }

    window.updateFPESContext = function() {
        let txt = ""; document.querySelectorAll('.pain-chip strong').forEach(p => txt += p.innerText + " | ");
        document.getElementById('fpesContextText').innerText = txt || "å°šç„¡ä¸»è¨´";
    };
    window.addFpesRow = function() {
        const d = document.createElement('div'); d.className='record-item';
        d.innerHTML = `<div class="row-controls"><select style="width:30%"><option>å€åŸŸ...</option><option>é ¸</option><option>èƒ¸</option><option>è…°</option><option>éª¨ç›†</option><option>é«–</option><option>è†</option><option>è¸</option></select><select style="width:30%" onchange="changeFpesInput(this)"><option value="muscle">è‚Œè‚‰</option><option value="joint">é—œç¯€</option><option value="peri">å‘¨åœ</option></select><div class="search-wrap"><input type="text" placeholder="æœå°‹..." onfocus="doSearch(this,'muscle')" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><button class="btn-del" onclick="this.parentElement.parentElement.remove()">Ã—</button></div><input type="text" placeholder="å‚™è¨»..." style="width:100%;border:none;border-bottom:1px solid #ccc;background:transparent;">`;
        document.getElementById('fpesContainer').appendChild(d);
    };
    window.changeFpesInput = function(sel) {
        const input = sel.nextElementSibling.querySelector('input'); input.value="";
        if(sel.value==='muscle'){ input.placeholder="æœå°‹è‚Œè‚‰..."; input.setAttribute('onfocus',"doSearch(this,'muscle')"); input.setAttribute('oninput',"doSearch(this,'muscle')"); }
        else if(sel.value==='joint'){ input.placeholder="é¸æ“‡é—œç¯€..."; input.setAttribute('onfocus',"doSearch(this,'joint')"); }
        else { input.placeholder="è¼¸å…¥çµ„ç¹”..."; input.removeAttribute('oninput'); input.removeAttribute('onfocus'); }
    };

    window.addInterferenceRow = function() {
        const d = document.createElement('div'); d.className='record-item';
        d.innerHTML = `<div style="display:flex;gap:5px;margin-bottom:5px;"><select style="width:40%"><option>å‹•ä½œ...</option><optgroup label="æ¨åŠ›"><option>A-P</option><option>P-A</option><option>L-R</option><option>R-L</option></optgroup><optgroup label="æ—‹è½‰"><option>ç«™æ—‹(å·¦)</option><option>ç«™æ—‹(å³)</option><option>åæ—‹(å·¦)</option><option>åæ—‹(å³)</option><option>å–®è…³ç«™</option></optgroup></select><div class="search-wrap" style="flex:1"><input type="text" placeholder="TL..." onfocus="doSearch(this,'muscle')" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><button class="btn-del" onclick="this.parentElement.parentElement.remove()">Ã—</button></div>`;
        document.getElementById('interferenceContainer').appendChild(d);
    };
    window.addLogicRow = function() {
        const d = document.createElement('div'); d.className='logic-row record-item'; d.style.background='#fffbeb';
        d.innerHTML = `<div style="margin-bottom:5px;font-weight:bold;color:#d97706;">åå‘ TL</div><div style="margin-bottom:5px">1. æŒ‡æ¨™è‚Œ: <div class="search-wrap" style="display:inline-block;width:70%"><input type="text" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div></div><div style="margin-bottom:5px">2. å£“åŠ›: <input type="text" style="width:70%"></div><div style="margin-bottom:5px">3. King: <div class="search-wrap" style="display:inline-block;width:70%"><input type="text" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div></div><div>4. Queen: <div class="search-wrap" style="display:inline-block;width:65%"><input type="text" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div> <button class="btn-del" style="float:right" onclick="this.parentElement.parentElement.remove()">Ã—</button></div>`;
        document.getElementById('logicContainer').appendChild(d);
    };
    window.addProtocolRow = function() {
        const d = document.createElement('div'); d.style.display='flex'; d.style.gap='5px'; d.style.marginBottom='10px';
        d.innerHTML = `<div class="search-wrap"><input type="text" placeholder="ä»£å„Ÿ" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><div class="search-wrap"><input type="text" placeholder="æŠ‘åˆ¶" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('protocolContainer').appendChild(d);
    };

    // --- 7. å­˜æª”èˆ‡æ­·å² ---
    function tempSave() {
        const data = { name: document.getElementById('pName').value };
        localStorage.setItem('nkt_v35_temp', JSON.stringify(data));
    }
    function searchHistory() {
        const name = document.getElementById('pName').value.trim();
        const panel = document.getElementById('historyPanel');
        const list = document.getElementById('historyList');
        if (!name) { panel.style.display = 'none'; return; }
        let db = JSON.parse(localStorage.getItem('nkt_history_db')) || [];
        let records = db.filter(r => r.name === name).reverse().slice(0, 3);
        if (records.length > 0) {
            panel.style.display = 'block'; list.innerHTML = "";
            records.forEach(r => { list.innerHTML += `<div class="history-card"><div class="history-date">${r.date}</div><div class="history-content">${r.summary}</div></div>`; });
        } else { panel.style.display = 'none'; }
    }
    function archiveRecord() {
        if(!confirm("ç¢ºå®šæ­¸æª”ï¼Ÿ")) return;
        const name = document.getElementById('pName').value.trim();
        if(!name) { alert("è«‹è¼¸å…¥å§“å"); return; }
        
        let summary = "";
        let pains = []; document.querySelectorAll('.pain-chip').forEach(p => pains.push(p.innerText.replace('Ã—','')));
        if(pains.length) summary += `[ä¸»è¨´] ${pains.join(', ')}\n`;
        let roms = []; document.querySelectorAll('.rom-record').forEach(r => roms.push(r.innerText.replace('Ã—','')));
        if(roms.length) summary += `[ROM] ${roms.join(', ')}\n`;
        // Gather NKT
        let nkt = ""; document.querySelectorAll('#protocolContainer input').forEach(i=>{ if(i.value) nkt+=i.value+" "; });
        if(nkt) summary += `[NKT] ${nkt}\n`;
        
        const record = { name: name, date: document.getElementById('dateToday').value, summary: summary || "ç„¡è©³ç´°ç´€éŒ„" };
        let db = JSON.parse(localStorage.getItem('nkt_history_db')) || [];
        db.push(record);
        localStorage.setItem('nkt_history_db', JSON.stringify(db));
        alert("å·²æ­¸æª”ï¼"); searchHistory();
    }
    function downloadText() {
        const name = document.getElementById('pName').value || "å®¢æˆ¶";
        const date = document.getElementById('dateToday').value;
        const blob = new Blob(["(è«‹åœ¨æ­¤å¯¦ä½œå®Œæ•´åŒ¯å‡ºé‚è¼¯...)"], { type: "text/plain" }); // ç°¡åŒ–
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `${date}_${name}.txt`; link.click();
    }
</script>

</body>
</html>

