<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº·ç™’ç¯‰é«” - AI è‡¨åºŠå¤§å¸«ç³»çµ± (v32.0 AI-Ready)</title>
    <style>
        /* --- 1. æ ¸å¿ƒè¦–è¦º (Design Tokens) --- */
        :root {
            --primary: #1e293b;   /* å°ˆæ¥­é»‘ */
            --brand: #059669;     /* å“ç‰Œç¶  */
            --brand-light: #ecfdf5;
            --accent: #d97706;    /* å»ºè­°æ©˜ */
            --fpes: #7c3aed;      /* FPES ç´« */
            --nkt: #0369a1;       /* NKT è— */
            --ai-btn: #8b5cf6;    /* AI æŒ‰éˆ•è‰² */
            --danger: #dc2626;    /* è­¦ç¤ºç´… */
            --bg: #f1f5f9;        /* ç°åº• */
            --white: #ffffff;
            --border: #cbd5e1;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 10px;
            padding-bottom: 120px;
            font-size: 16px;
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* --- 2. æ¨™é¡Œ --- */
        header {
            background: var(--white);
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border-top: 5px solid var(--brand);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        header h1 { font-size: 1.3rem; margin: 0; font-weight: 800; }

        /* --- 3. é¢æ¿ --- */
        .panel {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .section-header {
            font-size: 1.2rem; font-weight: 900; color: var(--primary);
            padding-bottom: 10px; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9;
            display: flex; align-items: center; gap: 8px;
        }
        .section-tag {
            background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 4px;
            font-size: 0.9rem; font-weight: bold;
        }
        
        h3 {
            margin: 0 0 15px 0; font-size: 1.1rem; color: var(--primary);
            display: flex; align-items: center; gap: 8px;
        }
        h3::before { content: ''; width: 5px; height: 20px; background: var(--brand); border-radius: 4px; }

        /* --- 4. è¼¸å…¥èˆ‡æ‰‹å‹•å‚™è¨» (Manual Input) --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        input[type="text"], input[type="tel"], input[type="date"], select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 8px; font-size: 1rem; background: #fff; appearance: none;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }
        
        /* æ‰‹å‹•å‚™è¨»æ¬„ä½æ¨£å¼ */
        .manual-note {
            width: 100%; margin-top: 10px; padding: 10px; border: 1px dashed #94a3b8; 
            background: #f8fafc; border-radius: 8px; font-size: 0.95rem; color: #334155;
            min-height: 50px; resize: vertical;
        }
        .manual-note:focus { background: #fff; border-color: var(--brand); border-style: solid; }

        /* --- 5. æ¨™ç±¤èˆ‡æŒ‰éˆ•ç³»çµ± --- */
        .tag-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .tag-btn {
            padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 6px;
            background: #fff; color: #64748b; font-size: 0.9rem; cursor: pointer;
        }
        .tag-btn.active { background: var(--brand); color: #fff; border-color: var(--brand); font-weight: bold;}
        .tag-btn.alert { border-color: #fca5a5; color: #dc2626; }
        .tag-btn.alert.active { background: #dc2626; color: #fff; border-color: var(--danger); }

        .goal-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .goal-btn {
            flex: 1; padding: 15px 5px; border: 2px solid #e2e8f0; border-radius: 12px;
            background: #fff; color: #64748b; font-weight: bold; cursor: pointer; text-align: center; transition: 0.2s;
        }
        .goal-btn.active { border-color: var(--brand); background: #ecfdf5; color: var(--brand); }

        /* --- 6. ä¸»è¨´å€å¡Š --- */
        .part-section { margin-bottom: 15px; }
        .part-label { font-size: 0.9rem; font-weight: bold; color: var(--accent); margin-bottom: 8px; display: block; border-left: 4px solid var(--accent); padding-left: 8px; }
        .part-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        @media (max-width: 400px) { .part-grid { grid-template-columns: repeat(3, 1fr); } }
        
        .part-btn {
            padding: 12px 2px; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px;
            text-align: center; font-weight: bold; color: #475569; cursor: pointer; font-size: 0.95rem;
        }
        .part-btn:active { background: #e2e8f0; transform: scale(0.95); }

        #painResult { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; padding: 10px; background: #f1f5f9; border-radius: 8px; border: 1px dashed #cbd5e1; min-height: 50px; }
        .pain-chip { background: var(--primary); color: #fff; padding: 8px 12px; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; animation: popIn 0.2s; }
        .pain-chip .del { cursor: pointer; opacity: 0.7; font-weight: bold; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- 7. ROM æŒ‰éˆ•ç³»çµ± --- */
        .rom-category-list { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .rom-cat-btn { flex: 0 0 auto; padding: 10px 16px; border-radius: 20px; background: #f1f5f9; color: #64748b; font-weight: bold; cursor: pointer; border: 1px solid #e2e8f0; }
        .rom-cat-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        .rom-action-area { display: none; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .rom-action-area.active { display: block; animation: fadeIn 0.2s; }
        .rom-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .rom-btn { padding: 12px 5px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; text-align: center; font-size: 0.9rem; font-weight: bold; color: #475569; cursor: pointer; }
        .rom-btn:active { background: #e2e8f0; }
        
        .rom-record { background: #fff7ed; border: 1px solid #fdba74; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .rom-record strong { color: #c2410c; }

        /* --- 8. AI & FPES & NKT & Button --- */
        #aiSuggestionBox { background: var(--bg); border: 1px solid #cbd5e1; border-radius: 8px; padding: 12px; margin-bottom: 20px; display: none; margin-top: 10px; }
        .ai-title { color: var(--primary); font-weight: 800; font-size: 0.95rem; margin-bottom: 10px; }
        .ai-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .ai-chip { background: #fff; color: var(--primary); border: 1px solid #cbd5e1; padding: 8px 14px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
        .ai-chip:hover { background: #e2e8f0; }

        .fpes-context { background: #f5f3ff; border: 1px solid #d8b4fe; border-radius: 8px; padding: 15px; margin-bottom: 15px; color: var(--fpes); }
        .search-wrap { position: relative; width: 100%; flex: 1; }
        .dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; background: #fff; border: 1px solid #94a3b8; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .dropdown li { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .dropdown li:active { background: #e2e8f0; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 5px; }
        .btn-add { background: #e0f2fe; color: #0284c7; border: 1px dashed #0284c7; }
        .btn-logic { background: #fef3c7; color: #d97706; border: 1px dashed #d97706; }
        .btn-del { width: 32px; height: 32px; padding: 0; background: #fee2e2; color: #ef4444; border-radius: 50%; font-size: 1.2rem; margin-left: auto; }
        
        .btn-save { background: #3b82f6; color: #fff; flex:1; }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #ec4899); color: #fff; flex:1; } /* AI Button */
        .btn-print { background: #f59e0b; color: #000; flex:1; }

        .record-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .row-controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 5px; }
        .logic-row { background: #fffbeb; border: 1px solid #fcd34d; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .logic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .logic-label { font-size: 0.8rem; font-weight: bold; color: #d97706; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-card { background: #fff; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-label { display: block; font-weight: bold; margin-bottom: 10px; color: #64748b; }
        .nail-input-box { display: none; margin-top: 10px; padding: 12px; border: 2px solid #fca5a5; background: #fff5f5; border-radius: 8px; }
        .nail-input-box.show { display: block; }

        @media print {
            .no-print, .btn, .rom-category-list { display: none !important; }
            .panel { box-shadow: none; border: 1px solid #000; break-inside: avoid; }
            input, select, textarea { border: none; padding: 0; resize: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <header class="no-print">
        <div>
            <h1>åº·ç™’ç¯‰é«”</h1>
            <span style="font-size:0.8rem; color:#666;">v32.0 AI-Integration</span>
        </div>
        <div style="width:100%; display:flex; gap:8px; margin-top:10px;">
            <button class="btn btn-save" onclick="saveData(true)">ğŸ’¾ æš«å­˜</button>
            <button class="btn btn-ai" onclick="generateAIPrompt()">ğŸ¤– AI åˆ†æ</button>
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ PDF</button>
        </div>
    </header>

    <div class="panel no-print">
        <h3>ğŸ¯ é¡§å®¢ä¸»è¦éœ€æ±‚ (Goal)</h3>
        <div class="goal-group">
            <div class="goal-btn" onclick="toggleGoal(this)">ğŸ’†â€â™‚ï¸ æ”¾é¬†æŒ‰æ‘©</div>
            <div class="goal-btn" onclick="toggleGoal(this)">ğŸ”§ è§£æ±ºå•é¡Œ</div>
            <div class="goal-btn" onclick="toggleGoal(this)">âœ¨ å…©è€…éƒ½æƒ³è¦</div>
        </div>
    </div>

    <div class="panel">
        <div class="consent-box">
            <h4 style="margin:0 0 10px 0;">âš ï¸ æœå‹™å…§å®¹è²æ˜èˆ‡ç°½ç½²åŒæ„</h4>
            <p>1. æœ¬äººäº†è§£ä¸¦åŒæ„æœ¬æ¬¡æ–¼ã€Œåº·ç™’ç¯‰é«”èº«é«”æ•´åˆä¿å¥æ•™å®¤ã€æ‰€æ¥å—ä¹‹æœå‹™ï¼Œå±¬æ–¼<strong>éé†«ç™‚æ€§è³ª</strong>ä¹‹èº«é«”ä¿å¥æ•™è‚²å¼•å°èˆ‡åŠŸèƒ½å‹•ä½œè¦ºå¯Ÿè«®è©¢æœå‹™ã€‚</p>
            <p>2. æœå‹™å…§å®¹åŒ…å«ï¼šè‚Œè‚‰è¦ºå¯Ÿå¼•å°ã€å§¿å‹¢èˆ‡å‹•ä½œè§€å¯Ÿå»ºè­°ã€å‹•ä½œæ¨¡å¼å¼•å°ç·´ç¿’ã€å‘¼å¸ç¯€å¥ç·´ç¿’ã€èº«é«”æ´»å‹•å¼•å°èˆ‡åŠŸèƒ½å‹•ä½œé«”é©—ç·´ç¿’ç­‰ã€‚</p>
            <p>3. æ‰€æœ‰æœå‹™çš†ä»¥å”åŠ©æ”¹å–„æ—¥å¸¸æ´»å‹•è¡¨ç¾ã€æå‡èº«é«”è‡ªæˆ‘è¦ºå¯Ÿèˆ‡å‹•ä½œæ•ˆç‡ç‚ºç›®æ¨™ï¼Œ<strong>ä¸æä¾›ç–¾ç—…è¨ºæ–·ã€æ²»ç™‚å»ºè­°æˆ–ç™‚æ•ˆä¿è­‰</strong>ï¼Œäº¦ä¸å–ä»£é†«ç™‚å°ˆæ¥­æ„è¦‹ã€‚</p>
            <p>4. è‹¥éç¨‹ä¸­æœ‰ä»»ä½•ä¸é©ï¼Œå°‡ä¸»å‹•å‘ŠçŸ¥ä¸¦çµ‚æ­¢æœå‹™äººå“¡æ“ä½œã€‚</p>
            <label class="consent-check">
                <input type="checkbox" id="consentCheck" onchange="saveData()">
                æœ¬äººå·²å……åˆ†äº†è§£ä¸¦åŒæ„ä¸Šè¿°èªªæ˜
            </label>
        </div>

        <h3>ğŸ“ å®¢æˆ¶åŸºæœ¬è³‡æ–™</h3>
        <div class="form-grid">
            <input type="text" id="pName" placeholder="å§“å Name" oninput="saveData()">
            <select id="pGender" onchange="saveData()" style="background:#fff;">
                <option value="">æ€§åˆ¥ Gender...</option>
                <option value="ç”·">ç”· (Male)</option>
                <option value="å¥³">å¥³ (Female)</option>
                <option value="å…¶ä»–">å…¶ä»– (Other)</option>
            </select>
            <input type="tel" id="pPhone" placeholder="é›»è©± Phone" oninput="saveData()">
            <div style="position:relative;">
                <span style="font-size:0.7rem;position:absolute;top:-8px;left:10px;background:#fff;padding:0 5px;color:#64748b;">ç”Ÿæ—¥ Birthday</span>
                <input type="date" id="pBirthday" oninput="saveData()">
            </div>
            <div style="position:relative;">
                <span style="font-size:0.7rem;position:absolute;top:-8px;left:10px;background:#fff;padding:0 5px;color:#64748b;">è©•ä¼°æ—¥æœŸ Date</span>
                <input type="date" id="dateToday" oninput="saveData()">
            </div>
            <input type="text" id="pTherapist" placeholder="è©•ä¼°è€… Therapist" oninput="saveData()">
        </div>
    </div>

    <div class="panel">
        <h3>ğŸ”´ ä¸é©éƒ¨ä½èˆ‡æ„Ÿå— (Chief Complaint)</h3>
        
        <div class="part-section">
            <span class="part-label">ä¸­è»¸/è»€å¹¹ (Axial)</span>
            <div class="part-grid">
                <div class="part-btn" onclick="openPainModal('é ­éƒ¨')">é ­éƒ¨</div>
                <div class="part-btn" onclick="openPainModal('é ¸éƒ¨')">é ¸éƒ¨</div>
                <div class="part-btn" onclick="openPainModal('èƒŒéƒ¨')">èƒŒéƒ¨</div>
                <div class="part-btn" onclick="openPainModal('è…°éƒ¨')">è…°éƒ¨</div>
                <div class="part-btn" onclick="openPainModal('éª¨ç›†')">éª¨ç›†</div>
            </div>
        </div>

        <div class="part-section">
            <span class="part-label">å››è‚¢ (Limbs)</span>
            <div class="part-grid">
                <div class="part-btn" onclick="openPainModal('è‚©è†€')">è‚©è†€</div>
                <div class="part-btn" onclick="openPainModal('ä¸Šè‡‚')">ä¸Šè‡‚</div>
                <div class="part-btn" onclick="openPainModal('è‚˜/å‰è‡‚')">è‚˜/å‰è‡‚</div>
                <div class="part-btn" onclick="openPainModal('æ‰‹éƒ¨')">æ‰‹è…•/æ‰‹</div>
                <div class="part-btn" onclick="openPainModal('é«–éƒ¨')">é«–éƒ¨</div>
                <div class="part-btn" onclick="openPainModal('å¤§è…¿')">å¤§è…¿</div>
                <div class="part-btn" onclick="openPainModal('è†è“‹')">è†è“‹</div>
                <div class="part-btn" onclick="openPainModal('å°è…¿')">å°è…¿</div>
                <div class="part-btn" onclick="openPainModal('è…³è¸/è¶³')">è…³è¸/è¶³</div>
            </div>
        </div>

        <div id="painResult"></div>
        <textarea class="manual-note" id="note_pain" placeholder="ğŸ“ æ‰‹å‹•å‚™è¨»ï¼šè«‹åœ¨æ­¤è¼¸å…¥æ›´å¤šä¸»è¨´ç´°ç¯€..." oninput="saveData()"></textarea>

        <hr style="border:0; border-top:1px dashed #cbd5e1; margin:20px 0;">

        <h3>ğŸƒ ç”Ÿæ´»èˆ‡ç—…å² (History)</h3>
        <label>å·¥ä½œèˆ‡ç”Ÿæ´»å‹æ…‹</label>
        <div class="tag-group">
            <div class="tag-btn" onclick="toggleBtn(this)">ä¹…å(>6hr)</div>
            <div class="tag-btn" onclick="toggleBtn(this)">ä¹…ç«™</div>
            <div class="tag-btn" onclick="toggleBtn(this)">ç¶“å¸¸æ¬é‡ç‰©</div>
            <div class="tag-btn" onclick="toggleBtn(this)">å¤–å‹™/é§•é§›</div>
            <div class="tag-btn" onclick="toggleBtn(this)">ç¾å®¹/æ‰‹æŠ€</div>
            <div class="tag-btn" onclick="toggleBtn(this)">æ•™å¸«/æ•™ç·´</div>
            <div class="tag-btn" onclick="toggleBtn(this)">é•·æœŸç†¬å¤œ</div>
        </div>
        <textarea class="manual-note" id="note_life" placeholder="ğŸ“ è£œå……å·¥ä½œç¿’æ…£..." oninput="saveData()" style="height:40px; min-height:40px;"></textarea>

        <label style="margin-top:15px;">é‹å‹•ç¿’æ…£</label>
        <div class="tag-group">
            <div class="tag-btn" onclick="toggleBtn(this)">ç„¡é‹å‹•ç¿’æ…£</div>
            <div class="tag-btn" onclick="toggleBtn(this)">ç‘œçˆ</div>
            <div class="tag-btn" onclick="toggleBtn(this)">å¥èº«/é‡è¨“</div>
            <div class="tag-btn" onclick="toggleBtn(this)">æ¸¸æ³³</div>
            <div class="tag-btn" onclick="toggleBtn(this)">æ…¢è·‘/æœ‰æ°§</div>
            <div class="tag-btn" onclick="toggleBtn(this)">ç™»å±±</div>
            <div class="tag-btn" onclick="toggleBtn(this)">æ­¦è¡“/èˆè¹ˆ</div>
            <div class="tag-btn" onclick="toggleBtn(this)">æŠ±çŸ³</div>
            <div class="tag-btn" onclick="toggleBtn(this)">è‡ªè¡Œè»Š</div>
        </div>
        <textarea class="manual-note" id="note_sport" placeholder="ğŸ“ è£œå……é‹å‹•ç¿’æ…£..." oninput="saveData()" style="height:40px; min-height:40px;"></textarea>

        <label style="margin-top:15px;">å¥åº·ç‹€æ³</label>
        <div class="tag-group">
            <div class="tag-btn" onclick="toggleBtn(this)">æƒ…ç·’å£“åŠ›å¤§</div>
            <div class="tag-btn" onclick="toggleBtn(this)">ç¡çœ å›°é›£</div>
            <div class="tag-btn" onclick="toggleBtn(this)">é•·æœŸæœè—¥</div>
            <div class="tag-btn" onclick="toggleBtn(this)">æ…¢æ€§ç—…(ä¸‰é«˜)</div>
            <div class="tag-btn alert" onclick="toggleBtn(this)">æ›¾å‹•éæ‰‹è¡“</div>
            <div class="tag-btn alert" onclick="toggleNail(this)">é«”å…§æœ‰é‹¼é‡˜</div>
        </div>
        <div id="nailInput" class="nail-input-box">
            <label style="color:#dc2626; font-weight:bold;">âš ï¸ è«‹è¨»æ˜é‹¼é‡˜ä½ç½®/å¹´ä»½ï¼š</label>
            <input type="text" id="note_nail" placeholder="ä¾‹å¦‚ï¼šå·¦è…³è¸ (2018å¹´)" oninput="saveData()">
        </div>
    </div>

    <div class="panel">
        <div class="section-header">
            <span class="section-tag">Step 1</span> å‹•ä½œå—é™å¿«ç¯© (ROM Check)
        </div>
        <p style="font-size:0.85rem; color:#64748b; margin-bottom:10px;">é»æ“Šåˆ†é¡ â†’ é»æ“Šå‹•ä½œ (AI å»ºè­°)</p>
        
        <div class="rom-category-list">
            <div class="rom-cat-btn active" onclick="showRomCat('neck')">é ­é ¸</div>
            <div class="rom-cat-btn" onclick="showRomCat('tspine')">èƒ¸æ¤</div>
            <div class="rom-cat-btn" onclick="showRomCat('trunk')">è…°æ¤</div>
            <div class="rom-cat-btn" onclick="showRomCat('scap')">è‚©èƒ›éª¨</div>
            <div class="rom-cat-btn" onclick="showRomCat('shld')">è‚©é—œç¯€</div>
            <div class="rom-cat-btn" onclick="showRomCat('hip')">é«–é—œç¯€</div>
            <div class="rom-cat-btn" onclick="showRomCat('knee')">è†/è¸</div>
        </div>

        <div id="rom-neck" class="rom-action-area active">
            <div class="rom-btn-grid">
                <div class="rom-btn" onclick="addRomRecord('é ­é ¸å‰å½')">å‰å½</div>
                <div class="rom-btn" onclick="addRomRecord('é ­é ¸å¾Œä»°')">å¾Œä»°</div>
                <div class="rom-btn" onclick="addRomRecord('é ­é ¸æ—‹è½‰', true)">æ—‹è½‰ (Rot)</div>
                <div class="rom-btn" onclick="addRomRecord('é ­é ¸å´å½', true)">å´å½ (SB)</div>
            </div>
        </div>
        <div id="rom-tspine" class="rom-action-area">
            <div class="rom-btn-grid">
                <div class="rom-btn" onclick="addRomRecord('èƒ¸æ¤æ—‹è½‰', true)">æ—‹è½‰ (Rot)</div>
                <div class="rom-btn" onclick="addRomRecord('èƒ¸æ¤å¾Œä»°')">å¾Œä»° (Ext)</div>
                <div class="rom-btn" onclick="addRomRecord('èƒ¸æ¤å‰å½')">å‰å½ (Flex)</div>
                <div class="rom-btn" onclick="addRomRecord('èƒ¸æ¤å´å½', true)">å´å½ (SB)</div>
            </div>
        </div>
        <div id="rom-trunk" class="rom-action-area">
            <div class="rom-btn-grid">
                <div class="rom-btn" onclick="addRomRecord('è…°æ¤å‰å½')">å‰å½</div>
                <div class="rom-btn" onclick="addRomRecord('è…°æ¤å¾Œä»°')">å¾Œä»°</div>
                <div class="rom-btn" onclick="addRomRecord('è…°æ¤æ—‹è½‰', true)">æ—‹è½‰ (Rot)</div>
                <div class="rom-btn" onclick="addRomRecord('è…°æ¤å´å½', true)">å´å½ (SB)</div>
            </div>
        </div>
        <div id="rom-scap" class="rom-action-area">
            <div class="rom-btn-grid">
                <div class="rom-btn" onclick="addRomRecord('è‚©èƒ›ä¸Šæ', true)">ä¸Šæ (Elev)</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©èƒ›ä¸‹å£“', true)">ä¸‹å£“ (Dep)</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©èƒ›å‰çª', true)">å‰çª (Pro)</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©èƒ›å¾Œç¸®', true)">å¾Œç¸® (Ret)</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©èƒ›ä¸Šæ—‹', true)">ä¸Šæ—‹</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©èƒ›ä¸‹æ—‹', true)">ä¸‹æ—‹</div>
            </div>
        </div>
        <div id="rom-shld" class="rom-action-area">
            <div class="rom-btn-grid">
                <div class="rom-btn" onclick="addRomRecord('è‚©å‰å±ˆ', true)">å‰å±ˆ (Flex)</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©å¾Œä¼¸', true)">å¾Œä¼¸ (Ext)</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©å¤–å±•', true)">å¤–å±• (Abd)</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©å…§æ—‹', true)">å…§æ—‹ (IR)</div>
                <div class="rom-btn" onclick="addRomRecord('è‚©å¤–æ—‹', true)">å¤–æ—‹ (ER)</div>
            </div>
        </div>
        <div id="rom-hip" class="rom-action-area">
            <div class="rom-btn-grid">
                <div class="rom-btn" onclick="addRomRecord('é«–å±ˆæ›²', true)">å±ˆæ›² (Flex)</div>
                <div class="rom-btn" onclick="addRomRecord('é«–å¾Œä¼¸', true)">å¾Œä¼¸ (Ext)</div>
                <div class="rom-btn" onclick="addRomRecord('é«–å¤–å±•', true)">å¤–å±• (Abd)</div>
                <div class="rom-btn" onclick="addRomRecord('é«–å…§æ—‹', true)">å…§æ—‹ (IR)</div>
                <div class="rom-btn" onclick="addRomRecord('é«–å¤–æ—‹', true)">å¤–æ—‹ (ER)</div>
            </div>
        </div>
        <div id="rom-knee" class="rom-action-area">
            <div class="rom-btn-grid">
                <div class="rom-btn" onclick="addRomRecord('è†ä¼¸ç›´', true)">è†ä¼¸ç›´</div>
                <div class="rom-btn" onclick="addRomRecord('æ·±è¹²å—é™')">æ·±è¹²å—é™</div>
                <div class="rom-btn" onclick="addRomRecord('è¶³èƒŒå±ˆ', true)">è¶³èƒŒå±ˆ</div>
                <div class="rom-btn" onclick="addRomRecord('è¶³è¹ å±ˆ', true)">è¶³è¹ å±ˆ</div>
            </div>
        </div>

        <div id="romResultList"></div>

        <div id="aiSuggestionBox">
            <div class="ai-title">âœ¨ æ™ºèƒ½å»ºè­° (é»æ“ŠåŠ å…¥æ”¾é¬†æ¸…å–®)</div>
            <div class="ai-chips" id="aiChipsContainer"></div>
        </div>

        <div style="margin-top:20px;">
            <label style="color:var(--brand); font-weight:bold;">ğŸ¯ é‡é»æ”¾é¬†éƒ¨ä½ (Focus)</label>
            <div id="relaxContainer"></div>
            <button class="btn btn-add no-print" onclick="addRelaxRow()">ï¼‹ æ–°å¢æ”¾é¬†è‚Œè‚‰</button>
            <textarea class="manual-note" id="note_relax" placeholder="ğŸ“ æ‰‹å‹•å‚™è¨»ï¼šé—œæ–¼å‹•ä½œå—é™çš„ç´°ç¯€..." oninput="saveData()"></textarea>
        </div>
    </div>

    <div class="panel">
        <div class="section-header" style="color:var(--fpes); border-color:var(--fpes);">
            <span class="section-tag" style="background:var(--fpes);">Step 2</span> FPES ç—›æºç¯©æª¢
        </div>
        
        <div class="fpes-context">
            <div class="fpes-context-title">ğŸ”´ ç›®å‰ä¸»è¨´ (åƒç…§)</div>
            <div id="fpesContextText" style="font-size:0.9rem;">å°šæœªè¨˜éŒ„</div>
        </div>

        <div id="fpesContainer"></div>
        <button class="btn btn-add" style="border-color:var(--fpes); color:var(--fpes);" onclick="addFpesRow()">ï¼‹ æ–°å¢ç¯©æª¢</button>
        <textarea class="manual-note" id="note_fpes" placeholder="ğŸ“ æ‰‹å‹•å‚™è¨»ï¼šFPES è§€å¯Ÿé‡é»..." oninput="saveData()"></textarea>
    </div>

    <div class="panel">
        <div class="section-header" style="color:var(--nkt); border-color:var(--nkt);">
            <span class="section-tag" style="background:var(--nkt);">Step 3</span> NKT è©•ä¼°
        </div>
        
        <h4 style="margin:10px 0; color:#475569;">1. å¹²æ“¾æ¸¬è©¦ (Provocation)</h4>
        <div id="interferenceContainer"></div>
        <button class="btn btn-add" onclick="addInterferenceRow()">ï¼‹ æ–°å¢æ¸¬è©¦</button>

        <h4 style="margin:20px 0 10px 0; color:#475569;">2. åå‘ TL (Reverse TL Logic)</h4>
        <div id="logicContainer"></div>
        <button class="btn btn-logic" onclick="addLogicRow()">ï¼‹ æ–°å¢é‚è¼¯</button>

        <h4 style="margin:20px 0 10px 0; color:#475569;">3. èª¿ç†é…å° (Protocol)</h4>
        <div id="protocolContainer"></div>
        <button class="btn btn-add" onclick="addProtocolRow()">ï¼‹ æ–°å¢é…å°</button>
        
        <textarea class="manual-note" id="note_nkt" placeholder="ğŸ“ æ‰‹å‹•å‚™è¨»ï¼šNKT æ¸¬è©¦ç´°ç¯€..." oninput="saveData()"></textarea>
    </div>

    <div class="panel">
        <h3>ğŸ“ ç¸½çµèˆ‡å»ºè­°</h3>
        <textarea id="summaryArea" rows="5" placeholder="è¼¸å…¥ç¸½çµ..." oninput="saveData()"></textarea>
    </div>

</div>

<div class="modal-overlay" id="painModal">
    <div class="modal-card">
        <div class="modal-title">éƒ¨ä½ç´°ç¯€ - <span id="modalPartTitle"></span></div>
        <div class="modal-sec">
            <div class="modal-label">æ–¹å‘ (Side)</div>
            <div class="tag-group" id="modalSide">
                <div class="tag-btn" onclick="selectSingle(this)">å·¦</div>
                <div class="tag-btn" onclick="selectSingle(this)">å³</div>
                <div class="tag-btn" onclick="selectSingle(this)">é›™å´</div>
                <div class="tag-btn" onclick="selectSingle(this)">ä¸­è»¸</div>
            </div>
        </div>
        <div class="modal-sec">
            <div class="modal-label">ç‹€æ…‹ (State)</div>
            <div class="tag-group" id="modalState">
                <div class="tag-btn" onclick="selectSingleState(this)">å‹• (Move)</div>
                <div class="tag-btn" onclick="selectSingleState(this)">éœ (Static)</div>
                <div class="tag-btn" onclick="selectSingleState(this)">ä¸åˆ†</div>
            </div>
        </div>
        <div class="modal-sec">
            <div class="modal-label">æ„Ÿå— (Sensation)</div>
            <div class="tag-group" id="modalSense">
                <div class="tag-btn" onclick="toggleBtn(this)">ç— </div>
                <div class="tag-btn" onclick="toggleBtn(this)">ç—›</div>
                <div class="tag-btn" onclick="toggleBtn(this)">éº»</div>
                <div class="tag-btn" onclick="toggleBtn(this)">ç·Š</div>
                <div class="tag-btn" onclick="toggleBtn(this)">å¡</div>
                <div class="tag-btn" onclick="toggleBtn(this)">ç„¡åŠ›</div>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" style="background:#fee2e2; color:#dc2626;" onclick="closeModal(false)">å–æ¶ˆ</button>
            <button class="btn" style="background:#3b82f6; color:#fff;" onclick="closeModal(true)">ç¢ºèª</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="romSideModal">
    <div class="modal-card">
        <div class="modal-title">å—é™æ–¹å‘</div>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn" style="background:#f1f5f9; color:#475569;" onclick="confirmRomSide('å·¦ (L)')">å·¦ (L)</button>
            <button class="btn" style="background:#f1f5f9; color:#475569;" onclick="confirmRomSide('å³ (R)')">å³ (R)</button>
            <button class="btn" style="background:#f1f5f9; color:#475569;" onclick="confirmRomSide('é›™å´')">é›™å´</button>
        </div>
        <button class="btn" style="background:#fee2e2; color:#dc2626;" onclick="document.getElementById('romSideModal').classList.remove('open')">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™åº« (Pro DB) ---
    const DB = [
        {n:"èƒ¸é–ä¹³çªè‚Œ (SCM)"}, {n:"ä¸Šæ–œæ–¹è‚Œ (UT)"}, {n:"æè‚©èƒ›è‚Œ (LS)"},
        {n:"è…¹ç›´è‚Œ (RA)"}, {n:"è…¹å¤–æ–œè‚Œ (EO)"}, {n:"è…¹å…§æ–œè‚Œ (IO)"}, {n:"è…¹æ©«è‚Œ (TVA)"},
        {n:"è…°æ–¹è‚Œ (QL)"}, {n:"è±è„Šè‚Œ (ES)"}, {n:"å¤šè£‚è‚Œ (MF)"}, {n:"æ·±å±¤é ¸å±ˆè‚Œ (DNF)"},
        {n:"èƒ¸å¤§è‚Œ (PMj)"}, {n:"èƒ¸å°è‚Œ (PMi)"}, {n:"å‰é‹¸è‚Œ (SA)"}, {n:"è±å½¢è‚Œ (RMB)"},
        {n:"é—ŠèƒŒè‚Œ (LD)"}, {n:"å¤§åœ“è‚Œ (Tmaj)"}, {n:"å°åœ“è‚Œ (TMn)"}, {n:"æ£˜ä¸Šè‚Œ (SSP)"},
        {n:"æ£˜ä¸‹è‚Œ (ISP)"}, {n:"è‚©èƒ›ä¸‹è‚Œ (SSC)"}, {n:"ä¸‰è§’è‚Œ (Deltoid)"}, {n:"è‚±äºŒé ­è‚Œ (BB)"},
        {n:"è‚±ä¸‰é ­è‚Œ (TB)"}, {n:"è…°å¤§è‚Œ (PM)"}, {n:"é«‚è‚Œ (IL)"}, {n:"è‡€å¤§è‚Œ (GMax)"},
        {n:"è‡€ä¸­è‚Œ (GMed)"}, {n:"è‡€å°è‚Œ (GMin)"}, {n:"æ¢¨ç‹€è‚Œ (Piri)"}, {n:"é—Šç­‹è†œå¼µè‚Œ (TFL)"}, {n:"è‚¡ç›´è‚Œ (RF)"},
        {n:"è…¿å¾Œè‚Œ (Hamstring)"}, {n:"è„›å‰è‚Œ (TA)"}, {n:"è…“è…¸è‚Œ (Gastroc)"}, {n:"æ¯”ç›®é­šè‚Œ (Soleus)"}
    ];

    const SUGGESTIONS = {
        "æ—‹è½‰": ["è…¹å¤–æ–œè‚Œ", "è…¹å…§æ–œè‚Œ", "é—ŠèƒŒè‚Œ", "èƒ¸é–ä¹³çªè‚Œ", "è±è„Šè‚Œ"],
        "å´å½": ["è…°æ–¹è‚Œ", "è±è„Šè‚Œ", "è…¹å¤–æ–œè‚Œ", "è…¹å…§æ–œè‚Œ"],
        "å‰å½": ["è±è„Šè‚Œ", "è…°æ–¹è‚Œ", "è…¿å¾Œè‚Œ", "è‡€å¤§è‚Œ"],
        "å¾Œä»°": ["è…¹ç›´è‚Œ", "è…°å¤§è‚Œ", "è‚¡ç›´è‚Œ", "é«‚è‚Œ"],
        "å‰å±ˆ": ["é—ŠèƒŒè‚Œ", "å¤§åœ“è‚Œ", "èƒ¸å¤§è‚Œ", "ä¸‰é ­è‚Œé•·é ­"],
        "å¤–å±•": ["é—ŠèƒŒè‚Œ", "èƒ¸å¤§è‚Œ", "å¤§åœ“è‚Œ"],
        "å…§æ—‹": ["æ£˜ä¸‹è‚Œ", "å°åœ“è‚Œ", "å¾Œä¸‰è§’è‚Œ"],
        "å¤–æ—‹": ["è‚©èƒ›ä¸‹è‚Œ", "å¤§åœ“è‚Œ", "èƒ¸å¤§è‚Œ"],
        "ä¸Šæ": ["ä¸‹æ–œæ–¹è‚Œ", "é—ŠèƒŒè‚Œ", "èƒ¸å°è‚Œ"],
        "ä¸‹å£“": ["ä¸Šæ–œæ–¹è‚Œ", "æè‚©èƒ›è‚Œ"],
        "ä¸Šæ—‹": ["æè‚©èƒ›è‚Œ", "è±å½¢è‚Œ", "èƒ¸å°è‚Œ"],
        "ä¸‹æ—‹": ["å‰é‹¸è‚Œ", "ä¸Šæ–œæ–¹è‚Œ"]
    };

    const JOINTS = ["C1-C7", "T1-T12", "L1-L5", "Sacrum", "SI Joint", "Hip", "Knee", "Ankle", "Shoulder", "Elbow", "Wrist"];

    // --- 2. åˆå§‹åŒ– ---
    window.onload = function() {
        document.getElementById('dateToday').valueAsDate = new Date();
        if(document.getElementById('relaxContainer').children.length === 0) addRelaxRow();
        if(document.getElementById('interferenceBody').children.length === 0) addInterferenceRow();
        if(document.getElementById('logicContainer').children.length === 0) addLogicRow();
        if(document.getElementById('treatmentBody').children.length === 0) addTreatmentRow();
        addFpesRow(); 
        loadData();
    };

    // --- 3. é‹¼é‡˜èˆ‡æ¨™ç±¤ ---
    window.toggleGoal = function(el) { el.parentElement.querySelectorAll('.goal-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); saveData(); };
    window.toggleBtn = function(el) { el.classList.toggle('active'); saveData(); };
    window.toggleNail = function(el) {
        el.classList.toggle('active');
        const box = document.getElementById('nailInput');
        if(el.classList.contains('active')) box.classList.add('show'); else box.classList.remove('show');
        saveData();
    };

    // --- 4. ä¸»è¨´ Modal ---
    let currentPart = "";
    window.openPainModal = function(part) {
        currentPart = part;
        document.getElementById('modalPartTitle').innerText = part;
        document.querySelectorAll('#modalSide .tag-btn, #modalState .tag-btn, #modalSense .tag-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('painModal').classList.add('open');
    };
    window.selectSingle = function(el) { el.parentElement.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); };
    window.selectSingleState = function(el) { el.parentElement.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); };
    window.closeModal = function(save) {
        if(save) {
            const side = document.querySelector('#modalSide .tag-btn.active')?.innerText || "";
            const state = document.querySelector('#modalState .tag-btn.active')?.innerText || "";
            const senses = [];
            document.querySelectorAll('#modalSense .tag-btn.active').forEach(b => senses.push(b.innerText));
            
            const div = document.createElement('div');
            div.className = 'pain-chip';
            div.innerHTML = `<strong>${currentPart}</strong> ${side?`(${side})`:''} ${state?`[${state}]`:''} ${senses.join(',')} <span class="del" onclick="this.parentElement.remove(); updateFPESContext()">Ã—</span>`;
            document.getElementById('painResult').appendChild(div);
            updateFPESContext();
        }
        document.getElementById('painModal').classList.remove('open');
        saveData();
    };

    // --- 5. ROM Buttons ---
    window.showRomCat = function(id) {
        document.querySelectorAll('.rom-action-area').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.rom-cat-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('rom-'+id).classList.add('active');
        event.target.classList.add('active');
    };

    let currentRomAction = "";
    window.addRomRecord = function(action, needSide=false) {
        if(needSide) { currentRomAction = action; document.getElementById('romSideModal').classList.add('open'); }
        else { createRomRecord(action, ""); }
    };
    window.confirmRomSide = function(side) {
        createRomRecord(currentRomAction, side);
        document.getElementById('romSideModal').classList.remove('open');
    };
    function createRomRecord(action, side) {
        const div = document.createElement('div');
        div.className = 'rom-record';
        let keyword = "";
        for(let k in SUGGESTIONS) if(action.includes(k)) keyword = k;
        let aiHtml = "";
        if(keyword && SUGGESTIONS[keyword]) {
            const box = document.getElementById('aiSuggestionBox');
            const container = document.getElementById('aiChipsContainer');
            box.style.display = 'block';
            SUGGESTIONS[keyword].forEach(m => {
                if(!container.innerHTML.includes(m)) {
                    let chip = document.createElement('div');
                    chip.className = 'ai-chip';
                    chip.innerHTML = `<span>+</span> ${m}`;
                    chip.onclick = function() { addRelaxRowWithValue(m); this.style.background = '#dcfce7'; this.innerHTML = `<span>âœ“</span> ${m}`; };
                    container.appendChild(chip);
                }
            });
        }
        div.innerHTML = `<div><strong>${action}</strong> ${side}</div> <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('romResultList').appendChild(div);
        saveData();
    }

    // --- 6. æœå°‹ (Search) L/R ---
    window.doSearch = function(input, type) {
        const val = input.value.toLowerCase().trim();
        const list = input.nextElementSibling;
        list.innerHTML = ''; list.style.display = 'none';
        
        if (type === 'muscle') {
            if(!val) return;
            const matches = DB.filter(d => d.n.toLowerCase().includes(val));
            if(matches.length > 0) {
                list.style.display = 'block';
                matches.forEach(item => {
                    let liL = document.createElement('li'); liL.innerHTML=`<span>${item.n} (L)</span>`; liL.onmousedown=function(e){e.preventDefault(); input.value=item.n+" (L)"; list.style.display='none';}; list.appendChild(liL);
                    let liR = document.createElement('li'); liR.innerHTML=`<span>${item.n} (R)</span>`; liR.onmousedown=function(e){e.preventDefault(); input.value=item.n+" (R)"; list.style.display='none';}; list.appendChild(liR);
                });
            }
        } else if (type === 'joint') {
            list.style.display = 'block';
            JOINTS.forEach(j => {
                let li = document.createElement('li'); li.innerHTML=`<span>${j}</span>`; li.onmousedown=function(e){e.preventDefault(); input.value=j; list.style.display='none';}; list.appendChild(li);
            });
        }
    };
    document.addEventListener('click', e => { if(!e.target.closest('.search-wrap')) document.querySelectorAll('.dropdown').forEach(d => d.style.display='none'); });

    // --- 7. FPES é‚è¼¯ ---
    window.updateFPESContext = function() {
        let txt = "";
        document.querySelectorAll('.pain-chip strong').forEach(p => txt += p.innerText + " | ");
        document.getElementById('fpesContextText').innerText = txt || "å°šç„¡ä¸»è¨´ç´€éŒ„";
    };

    window.addFpesRow = function() {
        const div = document.createElement('div');
        div.className = 'record-item';
        div.innerHTML = `
            <div class="row-controls">
                <select style="width:30%"><option>å€åŸŸ...</option><option>é ¸</option><option>èƒ¸</option><option>è…°</option><option>éª¨ç›†</option><option>é«–</option><option>è†</option><option>è¸</option></select>
                <select style="width:30%" onchange="changeFpesInput(this)"><option value="muscle">è‚Œè‚‰</option><option value="joint">é—œç¯€</option><option value="peri">å‘¨åœè»Ÿçµ„ç¹”</option></select>
                <div class="search-wrap"><input type="text" placeholder="æœå°‹è‚Œè‚‰..." onfocus="doSearch(this,'muscle')" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div>
                <button class="btn-del" onclick="this.parentElement.parentElement.remove()">Ã—</button>
            </div>
            <input type="text" placeholder="å‚™è¨» (Finding)..." style="width:100%; border:none; border-bottom:1px solid #ccc; background:transparent;">
        `;
        document.getElementById('fpesContainer').appendChild(div);
    };

    window.changeFpesInput = function(sel) {
        const input = sel.nextElementSibling.querySelector('input');
        input.value = "";
        if(sel.value === 'muscle') { input.placeholder="æœå°‹è‚Œè‚‰..."; input.setAttribute('oninput', "doSearch(this,'muscle')"); }
        else if(sel.value === 'joint') { input.placeholder="é¸æ“‡é—œç¯€..."; input.setAttribute('oninput', "doSearch(this,'joint')"); }
        else { input.placeholder="è¼¸å…¥çµ„ç¹”..."; input.removeAttribute('oninput'); }
    };

    // --- 8. NKT & Relax Rows ---
    window.addRelaxRow = function() {
        const div = document.createElement('div');
        div.style.marginBottom='10px'; div.style.display='flex'; div.style.gap='5px';
        div.innerHTML = `<div class="search-wrap" style="flex:1"><input type="text" placeholder="æœå°‹è‚Œè‚‰..." onfocus="doSearch(this,'muscle')" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('relaxContainer').appendChild(div);
    };
    function addRelaxRowWithValue(val) { addRelaxRow(); let inputs = document.querySelectorAll('#relaxContainer input'); inputs[inputs.length-1].value = val; }

    window.addInterferenceRow = function() {
        const div = document.createElement('div'); div.className = 'record-item';
        div.innerHTML = `<div style="display:flex;gap:5px;margin-bottom:5px;"><select style="width:40%"><option>å‹•ä½œ...</option><optgroup label="æ¨åŠ›"><option>A-P</option><option>P-A</option><option>L-R</option><option>R-L</option></optgroup><optgroup label="æ—‹è½‰"><option>ç«™æ—‹(å·¦)</option><option>ç«™æ—‹(å³)</option><option>åæ—‹(å·¦)</option><option>åæ—‹(å³)</option><option>å–®è…³ç«™</option></optgroup></select><div class="search-wrap" style="flex:1"><input type="text" placeholder="TL..." onfocus="doSearch(this,'muscle')" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><button class="btn-del" onclick="this.parentElement.parentElement.remove()">Ã—</button></div>`;
        document.getElementById('interferenceContainer').appendChild(div);
    };

    window.addLogicRow = function() {
        const div = document.createElement('div'); div.className = 'logic-row record-item'; div.style.background = '#fffbeb';
        div.innerHTML = `<div style="margin-bottom:5px;font-weight:bold;color:#d97706;">åå‘ TL</div><div style="margin-bottom:5px">1. æŒ‡æ¨™è‚Œ: <div class="search-wrap" style="display:inline-block; width:70%"><input type="text" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div></div><div style="margin-bottom:5px">2. å£“åŠ›: <input type="text" style="width:70%"></div><div style="margin-bottom:5px">3. King: <div class="search-wrap" style="display:inline-block; width:70%"><input type="text" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div></div><div>4. Queen: <div class="search-wrap" style="display:inline-block; width:65%"><input type="text" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div> <button class="btn-del" style="float:right" onclick="this.parentElement.parentElement.remove()">Ã—</button></div>`;
        document.getElementById('logicContainer').appendChild(div);
    };

    window.addProtocolRow = function() {
        const div = document.createElement('div'); div.style.display='flex'; div.style.gap='5px'; div.style.marginBottom='10px';
        div.innerHTML = `<div class="search-wrap"><input type="text" placeholder="ä»£å„Ÿ" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><div class="search-wrap"><input type="text" placeholder="æŠ‘åˆ¶" oninput="doSearch(this,'muscle')"><ul class="dropdown"></ul></div><button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('protocolContainer').appendChild(div);
    };

    // --- 9. AI ç”Ÿæˆ (Prompt) ---
    function generateAIPrompt() {
        // Collect Data
        let txt = `è§’è‰²ï¼šä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç‰©ç†æ²»ç™‚å¸«èˆ‡ NKT åŸ·è¡Œå¸«ã€‚\n\n`;
        txt += `ã€å€‹æ¡ˆè³‡æ–™ã€‘\n`;
        txt += `æ€§åˆ¥: ${document.getElementById('pGender').value}, ç”Ÿæ—¥: ${document.getElementById('pBirthday').value}\n`;
        
        txt += `\nã€ä¸»è¨´ (Chief Complaint)ã€‘\n`;
        document.querySelectorAll('.pain-chip').forEach(p => txt += `- ${p.innerText.replace('Ã—', '')}\n`);
        txt += `å‚™è¨»: ${document.getElementById('note_pain').value}\n`;

        txt += `\nã€ç”Ÿæ´»èˆ‡ç—…å²ã€‘\n`;
        document.querySelectorAll('.tag-btn.active').forEach(t => txt += `${t.innerText}, `);
        txt += `\nå·¥ä½œ: ${document.querySelector('#note_life')?.value || ''}`;
        txt += `\né‹å‹•: ${document.querySelector('#note_sport')?.value || ''}`;
        txt += `\né‹¼é‡˜: ${document.getElementById('note_nail')?.value || 'ç„¡'}\n`;

        txt += `\nã€å‹•ä½œå—é™ (ROM)ã€‘\n`;
        document.querySelectorAll('.rom-record').forEach(r => txt += `- ${r.innerText.replace('Ã—', '')}\n`);
        txt += `å‚™è¨»: ${document.getElementById('note_relax').value}\n`;

        txt += `\nã€FPES ç¯©æª¢ã€‘\n`;
        // Gather FPES data... (Simplified for prompt)
        txt += `å‚™è¨»: ${document.getElementById('note_fpes').value}\n`;

        txt += `\nã€NKT è©•ä¼°ã€‘\n`;
        // Gather NKT data...
        txt += `å‚™è¨»: ${document.getElementById('note_nkt').value}\n`;

        txt += `\nè«‹æ ¹æ“šä»¥ä¸Šæ•¸æ“šï¼Œçµ¦å‡ºï¼š\n1. ç­‹è†œéˆä»£å„Ÿé‚è¼¯æ¨æ¼” (Hypothesis)\n2. å»ºè­°çš„æ”¾é¬†èˆ‡è¨“ç·´èœå–®\n3. å¯èƒ½çš„ NKT æ¸¬è©¦æ–¹å‘ (King/Queen)`;

        // Copy to clipboard
        navigator.clipboard.writeText(txt).then(() => {
            alert("âœ… æç¤ºè©å·²è¤‡è£½ï¼è«‹è²¼çµ¦ ChatGPT/Geminiã€‚");
        });
    }

    // --- 10. å­˜æª” ---
    function saveData(alertMsg=false) {
        const data = {
            name: document.getElementById('pName').value,
            date: document.getElementById('dateToday').value,
            phone: document.getElementById('pPhone').value
        };
        localStorage.setItem('nkt_v32', JSON.stringify(data));
        if(alertMsg) alert("âœ… å·²æš«å­˜è‡³æœ¬è£ç½®ï¼");
    }

    function downloadText() {
        const name = document.getElementById('pName').value || "å®¢æˆ¶";
        const date = document.getElementById('dateToday').value || "æ—¥æœŸ";
        const summary = document.getElementById('summaryArea').value;
        
        let content = `ã€åº·ç™’ç¯‰é«” - è©•ä¼°ç´€éŒ„ã€‘\nå§“å: ${name}\næ—¥æœŸ: ${date}\n\n`;
        content += `[ä¸»è¨´]\n`;
        document.querySelectorAll('.pain-chip').forEach(p => content += `- ${p.innerText.replace('Ã—', '')}\n`);
        
        content += `\n[ROM å—é™]\n`;
        document.querySelectorAll('.rom-record').forEach(r => content += `- ${r.innerText.replace('Ã—', '')}\n`);
        
        content += `\n[ç¸½çµ]\n${summary}`;

        const blob = new Blob([content], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${date}_${name}_ç´€éŒ„.txt`;
        link.click();
    }

    function loadData() {
        const d = JSON.parse(localStorage.getItem('nkt_v32'));
        if(d) {
            document.getElementById('pName').value = d.name || "";
            document.getElementById('pPhone').value = d.phone || "";
        }
    }
</script>

</body>
</html>